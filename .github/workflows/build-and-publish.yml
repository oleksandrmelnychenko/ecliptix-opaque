name: Build & Publish

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Version override (e.g., 1.0.1)'
        required: false
        type: string

permissions:
  contents: write
  packages: write

jobs:
  build-native:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: linux-x64
            lib: libopaque_ffi.so
          - os: macos-14
            target: aarch64-apple-darwin
            artifact: osx-arm64
            lib: libopaque_ffi.dylib
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact: win-x64
            lib: opaque_ffi.dll
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Build FFI library
        working-directory: rust
        run: cargo build --release --package opaque-ffi --target ${{ matrix.target }}

      - name: Prepare artifacts
        shell: bash
        run: |
          mkdir -p artifacts/${{ matrix.artifact }}
          find rust/target/${{ matrix.target }}/release -maxdepth 1 \
            \( -name "*.so" -o -name "*.dylib" -o -name "*.dll" \) \
            -exec cp {} artifacts/${{ matrix.artifact }}/ \;
          ls -la artifacts/${{ matrix.artifact }}/

      - uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.artifact }}
          path: artifacts/${{ matrix.artifact }}/
          retention-days: 7

  build-apple-xcframework:
    name: Build XCFramework
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,aarch64-apple-ios,aarch64-apple-ios-sim,x86_64-apple-ios

      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0.2'

      - name: Build Rust FFI for all Apple targets
        working-directory: rust
        run: |
          cargo build --release --package opaque-ffi --target aarch64-apple-darwin
          cargo build --release --package opaque-ffi --target aarch64-apple-ios
          cargo build --release --package opaque-ffi --target aarch64-apple-ios-sim
          cargo build --release --package opaque-ffi --target x86_64-apple-ios

      - name: Create XCFramework
        run: |
          mkdir -p dist/apple
          xcodebuild -create-xcframework \
            -library rust/target/aarch64-apple-darwin/release/libopaque_ffi.a -headers rust/target/opaque_ffi.h \
            -library rust/target/aarch64-apple-ios/release/libopaque_ffi.a -headers rust/target/opaque_ffi.h \
            -output dist/apple/EcliptixOPAQUE.xcframework
          cd dist/apple && zip -r EcliptixOPAQUE.xcframework.zip EcliptixOPAQUE.xcframework
          shasum -a 256 EcliptixOPAQUE.xcframework.zip > EcliptixOPAQUE.xcframework.zip.sha256

      - uses: actions/upload-artifact@v4
        with:
          name: apple-xcframework
          path: dist/apple/
          retention-days: 30

  build-android:
    name: Build Android (${{ matrix.abi }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - abi: arm64-v8a
            target: aarch64-linux-android
          - abi: armeabi-v7a
            target: armv7-linux-androideabi
          - abi: x86_64
            target: x86_64-linux-android
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cargo-ndk
        run: cargo install cargo-ndk

      - name: Build
        working-directory: rust
        run: cargo ndk -t ${{ matrix.abi }} build --release --package opaque-ffi

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/android-${{ matrix.abi }}
          find rust/target/${{ matrix.target }}/release -maxdepth 1 -name "*.so" \
            -exec cp {} artifacts/android-${{ matrix.abi }}/ \;

      - uses: actions/upload-artifact@v4
        with:
          name: native-android-${{ matrix.abi }}
          path: artifacts/android-${{ matrix.abi }}/
          retention-days: 7

  publish-release:
    name: GitHub Release
    needs: [build-native, build-apple-xcframework, build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Determine version
        id: version
        run: |
          VERSION="${{ github.ref_name }}"
          echo "VERSION=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/apple-xcframework/EcliptixOPAQUE.xcframework.zip
            artifacts/apple-xcframework/EcliptixOPAQUE.xcframework.zip.sha256
          body: |
            ## Ecliptix OPAQUE v${{ steps.version.outputs.VERSION }}

            ### Swift Package Manager
            ```swift
            .binaryTarget(
                name: "EcliptixOPAQUEBinary",
                url: "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/EcliptixOPAQUE.xcframework.zip",
                checksum: "$(cat artifacts/apple-xcframework/EcliptixOPAQUE.xcframework.zip.sha256 | cut -d' ' -f1)"
            )
            ```

            ### Platforms
            - Linux x64
            - macOS arm64
            - Windows x64
            - iOS (arm64, simulator)
            - Android (arm64-v8a, armeabi-v7a, x86_64)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
