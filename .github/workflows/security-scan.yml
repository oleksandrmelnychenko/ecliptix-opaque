name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # ==========================================================================
  # Cargo Audit - Known Vulnerability Checking
  # ==========================================================================
  cargo-audit:
    name: Cargo Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run cargo audit
        working-directory: rust
        run: cargo audit

  # ==========================================================================
  # Cargo Deny - License & Advisory Checking
  # ==========================================================================
  cargo-deny:
    name: Cargo Deny
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deny
        run: cargo install cargo-deny

      - name: Run cargo deny check
        working-directory: rust
        run: |
          if [ -f deny.toml ]; then
            cargo deny check
          else
            echo "No deny.toml found, skipping cargo-deny checks."
            echo "Consider adding a deny.toml to enforce license and advisory policies."
          fi

  # ==========================================================================
  # Secret Scanning
  # ==========================================================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --only-verified

  # ==========================================================================
  # License Compliance Check
  # ==========================================================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for LICENSE file
        run: |
          if [ ! -f LICENSE ]; then
            echo "ERROR: LICENSE file not found"
            exit 1
          fi
          echo "LICENSE file found"
          head -5 LICENSE

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Check Rust dependency licenses
        working-directory: rust
        run: |
          echo "=== Checking Rust dependency license metadata ==="

          # Collect license info from Cargo metadata
          cargo metadata --format-version 1 --no-deps \
            | python3 -c "
          import json, sys
          meta = json.load(sys.stdin)
          for pkg in meta['packages']:
              name = pkg['name']
              license = pkg.get('license', 'UNKNOWN')
              print(f'  {name}: {license}')
          "

          echo ""
          echo "=== Checking all workspace dependency licenses ==="

          # List all transitive dependency licenses and flag problematic ones
          cargo metadata --format-version 1 \
            | python3 -c "
          import json, sys
          meta = json.load(sys.stdin)

          denied = ['GPL-3.0-only', 'GPL-3.0-or-later', 'AGPL-3.0-only', 'AGPL-3.0-or-later']
          errors = 0

          for pkg in meta['packages']:
              name = pkg['name']
              license = pkg.get('license', 'UNKNOWN')
              for d in denied:
                  if license and d in license:
                      print(f'ERROR: {name} uses denied license: {license}')
                      errors += 1

          if errors > 0:
              print(f'\n{errors} dependency(ies) with denied licenses found.')
              sys.exit(1)
          else:
              print('All dependency licenses are compatible.')
          "
