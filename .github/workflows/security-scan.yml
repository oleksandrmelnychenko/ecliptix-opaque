name: Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ==========================================================================
  # CodeQL Static Analysis (C++)
  # ==========================================================================
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libsodium-dev cmake build-essential
          # Install liboqs
          git clone --depth 1 --branch 0.12.0 https://github.com/open-quantum-safe/liboqs.git
          cd liboqs
          mkdir build && cd build
          cmake -DCMAKE_INSTALL_PREFIX=/usr/local -DBUILD_SHARED_LIBS=ON ..
          make -j$(nproc)
          sudo make install
          sudo ldconfig

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: cpp
          queries: security-extended,security-and-quality
          config: |
            paths-ignore:
              - '.deps/**'
              - 'build*/**'
              - 'cmake-build-*/**'
              - '**/catch2-src/**'

      - name: Build for analysis
        run: |
          mkdir -p build-codeql && cd build-codeql
          cmake .. \
            -DCMAKE_BUILD_TYPE=Debug \
            -DBUILD_CLIENT=ON \
            -DBUILD_SERVER=ON \
            -DBUILD_TESTS=OFF \
            -DENABLE_HARDENING=ON
          cmake --build . -j$(nproc)

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:cpp"

  # ==========================================================================
  # Dependency Review (on PRs)
  # Requires: Settings > Security > Dependency graph enabled
  # ==========================================================================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    continue-on-error: true  # Don't fail if Dependency Graph is not enabled

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high
          deny-licenses: GPL-3.0, AGPL-3.0

  # ==========================================================================
  # SBOM Generation
  # ==========================================================================
  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate SBOM (CycloneDX)
        uses: CycloneDX/gh-dotnet-generate-sbom@v1
        with:
          path: ./nuget
          github-bearer-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate C++ dependency list
        run: |
          mkdir -p sbom
          cat > sbom/dependencies.json << 'EOF'
          {
            "bomFormat": "CycloneDX",
            "specVersion": "1.5",
            "version": 1,
            "metadata": {
              "component": {
                "name": "Ecliptix.Security.OPAQUE",
                "version": "1.0.3",
                "type": "library"
              }
            },
            "components": [
              {
                "name": "libsodium",
                "version": "1.0.20",
                "type": "library",
                "purl": "pkg:github/jedisct1/libsodium@1.0.20",
                "licenses": [{"license": {"id": "ISC"}}]
              },
              {
                "name": "liboqs",
                "version": "0.12.0",
                "type": "library",
                "purl": "pkg:github/open-quantum-safe/liboqs@0.12.0",
                "licenses": [{"license": {"id": "MIT"}}]
              },
              {
                "name": "Catch2",
                "version": "3.4.0",
                "type": "library",
                "purl": "pkg:github/catchorg/Catch2@v3.4.0",
                "licenses": [{"license": {"id": "BSL-1.0"}}],
                "scope": "optional"
              }
            ]
          }
          EOF

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom/
          retention-days: 90

  # ==========================================================================
  # Secret Scanning Check
  # ==========================================================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --only-verified

  # ==========================================================================
  # License Compliance Check
  # ==========================================================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for LICENSE file
        run: |
          if [ ! -f LICENSE ]; then
            echo "ERROR: LICENSE file not found"
            exit 1
          fi
          echo "LICENSE file found"
          head -5 LICENSE

      - name: Verify dependency licenses
        run: |
          echo "=== Checking dependency licenses ==="
          echo "libsodium: ISC (permissive)"
          echo "liboqs: MIT (permissive)"
          echo "Catch2: BSL-1.0 (permissive, test only)"
          echo ""
          echo "All dependencies use permissive licenses compatible with MIT."

  # ==========================================================================
  # Security Policy Check
  # ==========================================================================
  security-policy-check:
    name: Security Policy Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify security documentation
        run: |
          echo "=== Checking required security documentation ==="

          files=(
            "SECURITY.md"
            "LICENSE"
            "CONTRIBUTING.md"
            "docs/isms/INFORMATION_SECURITY_POLICY.md"
            "docs/isms/RISK_ASSESSMENT_REGISTER.md"
            "docs/security-review/THREAT_MODEL.md"
          )

          missing=0
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "✓ Found: $file"
            else
              echo "✗ Missing: $file"
              missing=$((missing + 1))
            fi
          done

          if [ $missing -gt 0 ]; then
            echo ""
            echo "ERROR: $missing required security file(s) missing"
            exit 1
          fi

          echo ""
          echo "All required security documentation present."

      - name: Check debug logging disabled
        run: |
          echo "=== Verifying debug logging is guarded ==="
          errors=0

          # Check that debug_log.h has the guard
          if grep -q "ifdef OPAQUE_DEBUG_LOGGING" include/opaque/debug_log.h; then
            echo "✓ Debug logging properly guarded in debug_log.h"
          else
            echo "✗ ERROR: Debug logging not properly guarded in debug_log.h"
            errors=$((errors + 1))
          fi

          # Check that interop logging has guards
          if grep -q "ifdef OPAQUE_INTEROP_LOGGING" src/interop/initiator_exports.cpp; then
            echo "✓ Interop logging properly guarded in initiator_exports.cpp"
          else
            echo "✗ ERROR: Interop logging not properly guarded in initiator_exports.cpp"
            errors=$((errors + 1))
          fi

          if grep -q "ifdef OPAQUE_INTEROP_LOGGING" src/interop/responder_exports.cpp; then
            echo "✓ Interop logging properly guarded in responder_exports.cpp"
          else
            echo "✗ ERROR: Interop logging not properly guarded in responder_exports.cpp"
            errors=$((errors + 1))
          fi

          # Check that debug logging flags are not enabled in CMakeLists.txt
          if grep -qE "(OPAQUE_DEBUG_LOGGING|OPAQUE_INTEROP_LOGGING)" CMakeLists.txt; then
            echo "✗ ERROR: Debug logging flag found enabled in CMakeLists.txt"
            grep -E "(OPAQUE_DEBUG_LOGGING|OPAQUE_INTEROP_LOGGING)" CMakeLists.txt
            errors=$((errors + 1))
          else
            echo "✓ No debug logging flags enabled in CMakeLists.txt"
          fi

          # Verify sensitive data is not logged via LOG_HEX (which dumps actual key bytes)
          echo ""
          echo "=== Checking for sensitive data logging ==="

          # Check for session_key hex logging (actual key bytes, not size parameters)
          if grep -n 'LOG_HEX.*"session_key"' src/interop/*.cpp; then
            echo "✗ ERROR: session_key bytes are being logged in interop exports"
            errors=$((errors + 1))
          else
            echo "✓ session_key bytes are not logged"
          fi

          # Check for master_key hex logging (actual key bytes, not size parameters)
          if grep -n 'LOG_HEX.*"master_key"' src/interop/*.cpp; then
            echo "✗ ERROR: master_key bytes are being logged in interop exports"
            errors=$((errors + 1))
          else
            echo "✓ master_key bytes are not logged"
          fi

          # Check for private_key hex logging (actual key bytes, not size parameters)
          if grep -n 'LOG_HEX.*"private_key"' src/interop/*.cpp; then
            echo "✗ ERROR: private_key bytes are being logged in interop exports"
            errors=$((errors + 1))
          else
            echo "✓ private_key bytes are not logged"
          fi

          if [ $errors -gt 0 ]; then
            echo ""
            echo "ERROR: $errors security check(s) failed"
            exit 1
          fi

          echo ""
          echo "All logging security checks passed."
